### Сервер WireGuard:

На сервере, рассчитанном под VPN, нужно поднять три контейнера, проще всего это сделать через docker-compose.yml файл.

Пример файла:
``` yml
version: "3.8"

services:
  wireguard:
    image: linuxserver/wireguard
    container_name: wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Moscow
      - SERVERURL=  # Указать домен или IP сервера
      - SERVERPORT=51820
      - PEERS=5
      - PEERDNS=8.8.8.8
      - INTERNAL_SUBNET=10.13.13.0 # Подсеть для пользователей VPN
    volumes:
      - ./config:/config
      - /lib/modules:/lib/modules
    ports:
      - 51820:51820/udp
    restart: unless-stopped

  wireguard-ui:
    image: ngoduykhanh/wireguard-ui:latest
    container_name: wireguard-ui
    environment:
      - WGUI_USERNAME=admin # Логин для входа в веб интерфейс
      - WGUI_PASSWORD=admin # Пароль для входа в веб интерфейс
      - WGUversion: "3.8"

​￼services:
  ​￼wireguard:
    image: linuxserver/wireguard
    container_name: wireguard
    ​￼cap_add:
      - NET_ADMIN
      - SYS_MODULE
    ​￼environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Moscow
      - SERVERURL=  # Указать домен или IP сервера 
      - SERVERPORT=51820
      - PEERS=5
      - PEERDNS=8.8.8.8
      - INTERNAL_SUBNET=10.13.13.0 # Подсеть для пользователей VPN
    ​￼volumes:
      - ./config:/config
      - /lib/modules:/lib/modules
    ​￼ports:
      - 51820:51820/udp
    restart: unless-stopped

  ​￼wireguard-ui:
    image: ngoduykhanh/wireguard-ui:latest
    container_name: wireguard-ui
    ​￼environment:
      - WGUI_USERNAME=admin # Логин для входа в веб интерфейс
      - WGUI_PASSWORD=admin # пароль  для входа в веб интерфейс
      - WGUI_PORT=80 # Порт веб интерфейса
      - WIREGUARD_CONF_DIR=/etc/wireguard
      - WIREGUARD_UI_ADDRESS=0.0.0.0:5000
    ​￼volumes:
      - /path/to/wireguard/config:/etc/wireguard
      - ./data:/data
    ​￼ports:
      - 80:5000 # проксирование порта контейнера WireGuard UI на сервер
    restart: unless-stoppedI_PORT=5000 # Порт веб интерфейса
      - WIREGUARD_CONF_DIR=/etc/wireguard
      - WIREGUARD_UI_ADDRESS=0.0.0.0:5000
    volumes:
      - ./config:/etc/wireguard
      - ./data:/data
    restart: unless-stopped

  nginx:
    image: nginx:latest
    container_name: nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
      - 80:80
      - 443:443
    depends_on:
      - wireguard-ui
    restart: unless-stopped

volumes:
  config:
  data:
```

Конфигурация для nginx:
```
events {}

http {
    server {
        listen 80;
        server_name #Доменное имя или IP;

        location / {
            proxy_pass http://wireguard-ui:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    server {
        listen 443 ssl;
        server_name #Доменное имя или IP;

        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;

        location / {
            proxy_pass http://wireguard-ui:5000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}

```

1. Создание рабочего каталога:
```sh 
mkdir -p ~/wireguard-setup
cd ~/wireguard-setup
```

2. Прописать docker-compose.yml и nginx.conf файлы
   
3.  Создание папок для работы контейнеров:
```sh
mkdir -p ./config 
mkdir -p ./data
```
4. docker-compose up -d

После этого можно проверять веб интерфейс wireguard и подключение к VPN

## Сервер GitLab

Для корректной работы ГитЛаба нужно предоставить ему ssh порт, то есть 22 порт. Чтобы не потерять доступ до сервера, рекомендуется сначала поменять порт ssh на сервере.

На сервере, рассчитанном под систему контроля версий нужно поднять три контейнера при помощи системы контейнеризации docker и инструмента оркестрации docker-compose. 

Пример файла конфигурации выглядит следующим образом:

```yaml
version: '3.6'
services:
  nginx:
    image: nginx:1.23.3-alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - letsencrypt_cert:/etc/letsencrypt
      - letsencrypt_data:/var/www/certbot
      - ./nginx_configs/:/etc/nginx/conf.d/
    restart: "always"
    command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
    networks:
      frontend:
        ipv4_address: 10.6.0.2

  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - letsencrypt_cert:/etc/letsencrypt
      - letsencrypt_data:/var/www/certbot
      - letsencrypt_logs:/var/log/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew && chown -R 101:101 /etc/letsencrypt; sleep 12h & wait $${!}; done;'"
    networks:
      frontend:
        ipv4_address: 10.6.0.3

  gitlab-web:
    image: 'gitlab/gitlab-ce:latest'
    container_name: gitlab
    restart: always
    hostname: 'YOUR-DOMAIN'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://YOUR-DOMAIN'
        nginx['listen_port'] = 443
        nginx['listen_https'] = true
        letsencrypt['enable'] = false
        nginx['ssl_certificate'] = "/etc/letsencrypt/live/YOUR-DOMAIN/fullchain.pem"
        nginx['ssl_certificate_key'] = "/etc/letsencrypt/live/YOUR-DOMAIN/privkey.pem"
        gitlab_rails['gitlab_shell_ssh_port'] = 4224

        registry_external_url 'https://YOUR-REGISTRY-DOMAIN'
        gitlab_rails['registry_enabled'] = true
        registry['enable'] = true
        registry_nginx['enable'] = true
        registry_nginx['listen_port'] = 81
        registry_nginx['listen_https'] = false
        registry_nginx['proxy_set_headers'] = {
          "Host" => "$http_host",
          "X-Real-IP" => "$remote_addr",
          "X-Forwarded-For" => "$proxy_add_x_forwarded_for",
          "X-Forwarded-Proto" => "https",
          "X-Forwarded-Ssl" => "on"
        }

        prometheus_monitoring['enable'] = false
        grafana['enable'] = false
    ports:
      - '22:22'
    expose:
      - '81'
      - '80'
      - '443'
    volumes:
      - './config:/etc/gitlab'
      - './logs:/var/log/gitlab'
      - './data:/var/opt/gitlab'
      - 'nginx_letsencrypt_cert:/etc/letsencrypt/'
    shm_size: '256m'
    networks:
      frontend:
        ipv4_address: 10.6.0.10

networks:
  frontend:
    ipam:
      config:
        - subnet: 10.6.0.0/16

volumes:
  letsencrypt_cert:
  letsencrypt_data:
  letsencrypt_logs:
```

Для настройки прокси-сервера nginx требуется описать конфигурационный файл вида:

```
upstream gitlab {
    server 10.6.0.10:443;
}

upstream gitlab-registry {
    server 10.6.0.10:81;
}

server {
    listen 80;
    server_name YOUR-DOMAIN;
    location / {
        return 301 https://$host$request_uri;
    }    
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
}

server {
    listen 80;
    server_name YOUR-REGISTRY-DOMAIN;
    location / {
        return 301 https://$host$request_uri;
    }    
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
}

server {
    include mime.types;
    listen 443 ssl;
    server_name YOUR-DOMAIN;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_certificate /etc/letsencrypt/live/YOUR-DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/YOUR-DOMAIN/privkey.pem;

    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    client_max_body_size 500M;
    
    location / {
        proxy_read_timeout      300;
        proxy_connect_timeout   300;
        proxy_redirect          off;

        proxy_set_header        Host                $http_host;
        proxy_set_header        X-Real-IP           $remote_addr;
        proxy_set_header        X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto   https;
        proxy_set_header        X-Frame-Options     SAMEORIGIN;

        proxy_pass https://gitlab;
    }
}

server {
    include mime.types;
    listen 443 ssl;
    server_name YOUR-REGISTRY-DOMAIN;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_certificate /etc/letsencrypt/live/YOUR-REGISTRY-DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/YOUR-REGISTRY-DOMAIN/privkey.pem;

    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    client_max_body_size 0;

    location / {
        proxy_set_header        Host $host;
        proxy_pass http://gitlab-registry;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

1. Создание рабочего каталога:

```bash
mkdir -p ~/gitlab
cd ~/gitlab
```

2. Создать и записать вышеописанную конфигурацию в файлы docker-compose.yaml и nginx.conf:

```bash
touch docker-compose.yaml
### Запишите вышеописанные конфиги в файл docker-compose.yaml с помощью любого удобного вам редактора текста
mkdir -p ~/gitlab/nginx_configs
### Запишите вышеописанные конфиги в файл nginx.conf с помощью любого удобного вам редактора текста
touch ~/gitlab/nginx_configs/nginx.conf
```

3. Разверните настроенную конфигурацию системы с помощью команды:

```bash
docker-compose up -d
```

## Сервер GitLab Runner

На сервере, рассчитанном под исполнитель ci/cd нужно установить пакет gitlab-runner, согласно указанной в документации инструкцией:

1. Загрузка и установка пакета gitlab-runner с объектного хранилища s3, расположенного на серверах amazon: 

```bash
curl https://gitlab-runner-downloads.s3.amazonaws.com/latest/deb/gitlab-runner_amd64.deb -o /tmp/gitlab-runner.deb

dpkg -i /tmp/gitlab-runner.deb
```

1. Конфигурация файла /etc/gitlab-runner/config.toml для gitlab-runner с исполнителем типа docker-executor:

```toml
concurrent = 1
check_interval = 0
shutdown_timeout = 0

[session_server]
  session_timeout = 1800

[[runners]]
  name = "Gitlab Runner"
  url = "https://YOUR-DOMAIN"
  id = 1
  token = "YOUR-TOKEN"
  token_obtained_at = 2024-02-10T14:10:52Z
  token_expires_at = 0001-01-01T00:00:00Z
  executor = "docker"
  [runners.custom_build_dir]
  [runners.cache]
    MaxUploadedArchiveSize = 0
    [runners.cache.s3]
    [runners.cache.gcs]
    [runners.cache.azure]
  [runners.docker]
    tls_verify = false
    image = "23.0.1-dind-alpine3.17"
    privileged = true
    disable_entrypoint_overwrite = false
    oom_kill_disable = false
    disable_cache = false
    volumes = ["/certs/", "/cache"]
    shm_size = 0
```
